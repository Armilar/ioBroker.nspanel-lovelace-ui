{
  "version": 3,
  "sources": ["../../../src/lib/classes/Page.ts"],
  "sourcesContent": ["import { Panel } from '../controller/panel';\nimport { BaseClassPage, BaseClassTriggerdInterface } from '../controller/states-controller';\nimport * as pages from '../types/pages';\nimport { ButtonActionType, IncomingEvent, PopupType, TemplateIdent, isPopupType } from '../types/types';\nimport { PageItem } from '../pages/pageItem';\nimport { BaseClass } from './library';\nimport { cardTemplates } from '../templates/card';\nimport { deepAssign, getRegExp } from '../const/tools';\nimport { PageItemDataItemsOptions, PageItemOptionsTemplate } from '../types/type-pageItem';\nimport { pageItemTemplates } from '../templates/templateArray';\n\nexport type PageItemInterface = BaseClassTriggerdInterface & {\n    card: pages.PageTypeCards;\n    panel: Panel;\n    id: string;\n    parent: Page;\n};\n\nexport type PageInterface = BaseClassTriggerdInterface & {\n    card: pages.PageTypeCards;\n    panel: Panel;\n    id: string;\n};\n\n//interface Page extends BaseClass | PageConfig\nexport type PageConfigAll = pages.PageBaseConfig;\n\nexport class Page extends BaseClassPage {\n    readonly card: pages.PageTypeCards;\n    readonly id: string;\n    //readonly enums: string | string[];\n    config: pages.PageBaseConfig['config'];\n    //config: Card['config'];\n    constructor(card: PageInterface, pageItemsConfig: pages.PageBaseConfig | undefined) {\n        super(card, pageItemsConfig && pageItemsConfig.pageItems);\n        this.card = card.card;\n        this.id = card.id;\n        this.enums =\n            pageItemsConfig && 'enums' in pageItemsConfig && pageItemsConfig.enums ? pageItemsConfig.enums : '';\n        this.device =\n            pageItemsConfig && 'device' in pageItemsConfig && pageItemsConfig.device ? pageItemsConfig.device : '';\n        if (this.device) {\n            card.dpInit = typeof card.dpInit === 'string' ? card.dpInit.replace('#\u00B0^\u00B0#', this.device) : card.dpInit;\n        }\n        if (card.dpInit && typeof card.dpInit === 'string') {\n            const reg = getRegExp(card.dpInit);\n            if (reg) {\n                card.dpInit = reg;\n            }\n        }\n        this.dpInit = card.dpInit ?? '';\n        this.config = pageItemsConfig && pageItemsConfig.config;\n    }\n\n    /**\n     * ...\n     */\n    async init(): Promise<void> {\n        // do the work f\u00FCr PageItems only one time - changes in ObjectDB need a adapter restart.\n        if (this.pageItemConfig) {\n            for (let a = 0; a < this.pageItemConfig.length; a++) {\n                let options = this.pageItemConfig[a];\n                if (options === undefined) continue;\n\n                options = await this.getItemFromTemplate(options);\n                if (!options) continue;\n                if (options.device) {\n                    this.log.debug('found');\n                }\n\n                options.dpInit =\n                    typeof options.dpInit === 'string' && options.device\n                        ? options.dpInit.replace('#\u00B0^\u00B0#', options.device)\n                        : options.dpInit;\n\n                if (options.dpInit && typeof options.dpInit === 'string') {\n                    const reg = getRegExp(options.dpInit);\n                    if (reg) {\n                        options.dpInit = reg;\n                    }\n                }\n                // search states for mode auto\n                const dpInit = (this.dpInit ? this.dpInit : options.dpInit) ?? '';\n                const enums = this.enums ? this.enums : options.enums;\n\n                options.data =\n                    dpInit || enums\n                        ? await this.panel.statesControler.getDataItemsFromAuto(\n                              (this.dpInit ? this.dpInit : options.dpInit) ?? '',\n                              options.data,\n                              'appendix' in options ? options.appendix : undefined,\n                              this.enums ? this.enums : options.enums,\n                          )\n                        : options.data;\n\n                this.pageItemConfig[a] = options;\n            }\n        }\n    }\n\n    async getItemFromTemplate(\n        options: PageItemDataItemsOptions,\n        subtemplate: TemplateIdent = '',\n        loop: number = 0,\n    ): Promise<PageItemDataItemsOptions | undefined> {\n        if ('template' in options && options.template) {\n            const template: PageItemOptionsTemplate | undefined = subtemplate\n                ? pageItemTemplates[subtemplate]\n                : pageItemTemplates[options.template];\n            const name = options.template;\n            if (!template) {\n                this.log.error('Dont find template ' + options.template);\n                return undefined;\n            }\n            if (\n                template.adapter &&\n                typeof options.dpInit === 'string' &&\n                !options.dpInit.includes(template.adapter) &&\n                typeof this.dpInit === 'string' &&\n                !this.dpInit.includes(template.adapter)\n            ) {\n                this.log.error(\n                    'Missing dbInit or dbInit not starts with' + template.adapter + ' for template ' + options.template,\n                );\n                return undefined;\n            }\n\n            const newTemplate = structuredClone(template) as Partial<PageItemOptionsTemplate>;\n            delete newTemplate.adapter;\n            if (options.type && options.type !== template.type) {\n                this.log.error('Type: ' + options.type + 'is not equal with ' + template.type);\n                return undefined;\n            }\n            options.type = template.type;\n            options.role = template.role;\n            if (options.appendix) {\n                this.log.debug('c');\n            }\n            options = deepAssign(newTemplate, options);\n            if (template.template !== undefined) {\n                if (loop > 10) {\n                    throw new Error(\n                        `Endless loop in getItemFromTemplate() detected! From ${template.template} for ${name}. Bye Bye`,\n                    );\n                }\n                const o = await this.getItemFromTemplate(options, template.template, ++loop);\n                if (o !== undefined) options = o;\n                else this.log.warn(`Dont get a template from ${template.template} for ${name}`);\n            }\n        }\n        return options;\n    }\n\n    async onButtonEvent(event: IncomingEvent): Promise<void> {\n        this.log.warn(`Event received but no handler! ${JSON.stringify(event)}`);\n    }\n    sendType(): void {\n        this.sendToPanel(`pageType~${this.card}`);\n    }\n\n    static getPage(config: pages.PageBaseConfig, that: BaseClass): pages.PageBaseConfig {\n        if ('template' in config && config.template) {\n            const template = cardTemplates[config.template];\n            if (!template) {\n                that.log.error('dont find template ' + config.template);\n                return config;\n            }\n            if (config.dpInit && typeof config.dpInit === 'string') {\n                const reg = getRegExp(config.dpInit);\n                if (reg) {\n                    config.dpInit = reg;\n                }\n                if (\n                    template.adapter &&\n                    typeof config.dpInit === 'string' &&\n                    !config.dpInit.startsWith(template.adapter)\n                ) {\n                    return config;\n                }\n            }\n            const newTemplate = structuredClone(template) as Partial<pages.PageBaseConfigTemplate>;\n            delete newTemplate.adapter;\n            if (config.card && config.card !== template.card) {\n                that.log.error(config.card + 'is not equal with ' + template.card);\n                return config;\n            }\n\n            config = deepAssign(newTemplate, config);\n        }\n        return config;\n    }\n    protected async createPageItems(): Promise<void> {\n        if (!this.pageItems && this.pageItemConfig) {\n            this.pageItems = [];\n            for (let a = 0; a < this.pageItemConfig.length; a++) {\n                const config: Omit<PageItemInterface, 'pageItemsConfig'> = {\n                    name: 'PI',\n                    adapter: this.adapter,\n                    panel: this.panel,\n                    panelSend: this.panelSend,\n                    card: 'cardItemSpecial',\n                    id: `${this.id}?${a}`,\n                    parent: this,\n                };\n                this.pageItems[a] = await PageItem.getPageItem(config, this.pageItemConfig[a]);\n            }\n        }\n    }\n    protected async onVisibilityChange(val: boolean): Promise<void> {\n        if (val) {\n            await this.createPageItems();\n            this.sendType();\n            this.update();\n        } else {\n            if (this.pageItems) {\n                for (const item of this.pageItems) {\n                    item && (await item.delete());\n                }\n                this.pageItems = undefined;\n            }\n        }\n    }\n\n    setLastPage(_p: Page | undefined): void {}\n    removeLastPage(_p: Page | undefined): void {}\n\n    protected getNavigation(): string {\n        return this.panel.navigation.buildNavigationString();\n    }\n\n    public async update(): Promise<void> {\n        this.adapter.log.warn(\n            `<- instance of [${Object.getPrototypeOf(this)}] update() is not defined or call super.onStateTrigger()`,\n        );\n    }\n\n    public async onPopupRequest(\n        id: number | string,\n        popup: PopupType | undefined,\n        action: ButtonActionType | undefined | string,\n        value: string | undefined,\n        _event: IncomingEvent | null = null,\n    ): Promise<void> {\n        if (!this.pageItems) return;\n        const i = typeof id === 'number' ? id : parseInt(id);\n        const item = this.pageItems[i];\n        if (!item) return;\n        let msg: string | null = null;\n        if (action && value !== undefined && (await item.onCommand(action, value))) {\n            return;\n        } else if (isPopupType(popup) && action !== 'bExit') {\n            msg = await item.GeneratePopup(popup);\n        }\n        if (msg !== null) {\n            this.sleep = true;\n            this.sendToPanel(msg);\n        }\n    }\n    async delete(): Promise<void> {\n        await super.delete();\n        this.pageItems = undefined;\n    }\n}\n\nexport function isMediaButtonActionType(F: MediaButtonActionType | string): F is MediaButtonActionType {\n    switch (F) {\n        case 'media-back':\n        case 'media-pause':\n        case 'media-next':\n        case 'media-shuffle':\n        case 'volumeSlider':\n        case 'mode-speakerlist':\n        case 'mode-playlist':\n        case 'mode-tracklist':\n        case 'mode-repeat':\n        case 'mode-equalizer':\n        case 'mode-seek':\n        case 'mode-crossfade':\n        case 'mode-favorites':\n        case 'mode-insel':\n        case 'media-OnOff':\n        case 'button':\n            return true;\n    }\n    console.error(`${F} isMediaButtonActionType === false`);\n    return false;\n}\ntype MediaButtonActionType = Extract<\n    ButtonActionType,\n    | 'media-back'\n    | 'media-pause'\n    | 'media-next'\n    | 'media-shuffle'\n    | 'volumeSlider'\n    | 'mode-speakerlist'\n    | 'mode-playlist'\n    | 'mode-tracklist'\n    | 'mode-repeat'\n    | 'mode-equalizer'\n    | 'mode-seek'\n    | 'mode-crossfade'\n    | 'mode-favorites'\n    | 'mode-insel'\n    | 'media-OnOff'\n    | 'button'\n>;\n"],
  "mappings": "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",
  "names": []
}
