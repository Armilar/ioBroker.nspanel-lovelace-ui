{
  "version": 3,
  "sources": ["../../../src/lib/controller/controller.ts"],
  "sourcesContent": ["import * as MQTT from '../classes/mqtt';\nimport * as Library from '../classes/library';\nimport { StatesControler } from './states-controller';\nimport * as Panel from './panel';\nimport { genericStateObjects } from '../const/definition';\nimport { SystemNotifications } from '../classes/system-notifications';\nimport { getInternalDefaults } from '../const/tools';\nimport axios from 'axios';\nimport { TasmotaOnlineResponse } from '../types/types';\n\naxios.defaults.timeout = 10000;\n\nexport class Controller extends Library.BaseClass {\n    mqttClient: MQTT.MQTTClientClass;\n    statesControler: StatesControler;\n    panels: Panel.Panel[] = [];\n    private minuteLoopTimeout: ioBroker.Timeout | undefined;\n    private dateUpdateTimeout: ioBroker.Timeout | undefined;\n    private dailyIntervalTimeout: ioBroker.Interval | undefined;\n    private dataCache: Record<string, { time: number; data: any }> = {};\n    systemNotification: SystemNotifications;\n\n    constructor(\n        adapter: Library.AdapterClassDefinition,\n        options: { mqttClient: MQTT.MQTTClientClass; name: string; panels: Partial<Panel.panelConfigPartial>[] },\n    ) {\n        super(adapter, options.name);\n        this.adapter.controller = this;\n        this.mqttClient = options.mqttClient;\n        this.statesControler = new StatesControler(this.adapter);\n\n        for (const panelConfig of options.panels) {\n            if (panelConfig === undefined) continue;\n            panelConfig.controller = this;\n            const panel = new Panel.Panel(adapter, panelConfig as Panel.panelConfigPartial);\n            this.panels.push(panel);\n        }\n        this.systemNotification = new SystemNotifications(this.adapter);\n    }\n\n    minuteLoop = async (): Promise<void> => {\n        if (this.unload) return;\n        this.statesControler.setInternalState('///time', await this.getCurrentTime(), true);\n        const diff = 60000 - (Date.now() % 60000) + 10;\n        this.minuteLoopTimeout = this.adapter.setTimeout(this.minuteLoop, diff);\n    };\n\n    /**\n     * Update Date every hour.\n     * @returns\n     */\n    dateUpdateLoop = async (): Promise<void> => {\n        if (this.unload) return;\n        const d: Date = new Date();\n        d.setDate(d.getDate() + 1);\n        d.setHours(0, 0, 1);\n        const diff = d.getTime() - Date.now();\n        this.log.debug('Set current Date with time: ' + new Date(await this.getCurrentTime()).toString);\n        await this.statesControler.setInternalState('///date', await this.getCurrentTime(), true);\n        this.dateUpdateTimeout = this.adapter.setTimeout(this.dateUpdateLoop, diff);\n    };\n    getCurrentTime = async (): Promise<number> => {\n        return Date.now();\n    };\n\n    /**\n     *....\n     * @param id\n     * @param _state\n     * @returns\n     */\n    onInternalCommand = async (id: string, _state: ioBroker.State | undefined): Promise<ioBroker.StateValue> => {\n        if (!id.startsWith('///')) return null;\n        const token = id.split('///').pop();\n        switch (token) {\n            case 'AdapterStoppedBoolean':\n            case 'AdapterNoConnectionBoolean':\n            case 'AdapterNoConnection':\n            case 'AdapterStopped': {\n                if (this.dataCache[token] && this.dataCache[token].time < Date.now() - 5000)\n                    delete this.dataCache[token];\n                let save = false;\n                if (!this.dataCache[token]) {\n                    this.dataCache[token] = { time: Date.now(), data: {} };\n                    save = true;\n                }\n                let list;\n                if (save) {\n                    list = await this.adapter.getObjectViewAsync('system', 'instance', {\n                        startkey: `system.adapter`,\n                        endkey: `system.adapter}`,\n                    });\n                    this.dataCache[token].data[`system#view.instance`] = list;\n                } else {\n                    list = this.dataCache[token].data[`system#view.instance`];\n                }\n\n                let total = 0;\n                let withProblems = 0;\n                for (const item of list.rows) {\n                    const obj = item.value;\n                    if (!obj.common.enabled || obj.common.mode !== 'daemon') continue;\n                    if (token === 'AdapterStopped' || token === 'AdapterStoppedBoolean') {\n                        let state;\n                        if (save) {\n                            state = await this.adapter.getForeignStateAsync(`${item.id}.alive`);\n                            this.dataCache[token].data[`${item.id}.alive`] = state;\n                        } else {\n                            state = this.dataCache[token].data[`${item.id}.alive`];\n                        }\n                        if (state && !state.val) {\n                            withProblems++;\n                            if (token === 'AdapterStoppedBoolean') return true;\n                        }\n                        total++;\n                    } else if (token === 'AdapterNoConnection' || token === 'AdapterNoConnectionBoolean') {\n                        const nID = item.id.split('.').slice(2).join('.');\n                        let state;\n                        if (save) {\n                            state = await this.adapter.getForeignStateAsync(`${nID}.info.connection`);\n                            this.dataCache[token].data[`${nID}.info.connection`] = state;\n                        } else {\n                            state = this.dataCache[token].data[`${nID}.info.connection`];\n                        }\n                        if (state && !state.val) {\n                            withProblems++;\n                            if (token === 'AdapterNoConnectionBoolean') return true;\n                        }\n                        total++;\n                    }\n                }\n                if (token === 'AdapterNoConnectionBoolean' || token === 'AdapterStoppedBoolean') return false;\n                return `(${withProblems}/${total})`;\n            }\n        }\n        return null;\n    };\n    async init(): Promise<void> {\n        await this.statesControler.setInternalState(\n            '///time',\n            await this.getCurrentTime(),\n            true,\n            {\n                name: '',\n                type: 'number',\n                role: 'value.time',\n                read: true,\n                write: false,\n            },\n            this.getCurrentTime,\n        );\n        await this.statesControler.setInternalState(\n            '///date',\n            await this.getCurrentTime(),\n            true,\n            {\n                name: '',\n                type: 'number',\n                role: 'value.time',\n                read: true,\n                write: false,\n            },\n            this.getCurrentTime,\n        );\n        await this.statesControler.setInternalState(\n            `///AdapterNoConnection`,\n            '',\n            true,\n            getInternalDefaults('string', 'text', false),\n            this.onInternalCommand,\n        );\n        await this.statesControler.setInternalState(\n            `///AdapterStopped`,\n            '',\n            true,\n            getInternalDefaults('string', 'text', false),\n            this.onInternalCommand,\n        );\n        await this.statesControler.setInternalState(\n            `///AdapterNoConnectionBoolean`,\n            true,\n            true,\n            getInternalDefaults('boolean', 'indicator', false),\n            this.onInternalCommand,\n        );\n        await this.statesControler.setInternalState(\n            `///AdapterStoppedBoolean`,\n            true,\n            true,\n            getInternalDefaults('boolean', 'indicator', false),\n            this.onInternalCommand,\n        );\n        const newPanels = [];\n        // erzeuge \u00FCbergeordneten channel\n        await this.library.writedp(`panels`, undefined, genericStateObjects.panel._channel);\n\n        await this.systemNotification.init();\n\n        for (const panel of this.panels)\n            if (await panel.isValid()) {\n                newPanels.push(panel);\n                await panel.init();\n            } else {\n                await panel.delete();\n                this.log.error(`Panel ${panel.name} has a invalid configuration.`);\n            }\n        this.panels = newPanels;\n        this.minuteLoop();\n        this.dateUpdateLoop();\n        await this.getTasmotaVersion();\n        this.dailyIntervalTimeout = this.adapter.setInterval(this.dailyInterval, 24 * 60 * 60 * 1000);\n    }\n    async delete(): Promise<void> {\n        if (this.minuteLoopTimeout) this.adapter.clearTimeout(this.minuteLoopTimeout);\n        if (this.dateUpdateTimeout) this.adapter.clearTimeout(this.dateUpdateTimeout);\n        if (this.dailyIntervalTimeout) this.adapter.clearInterval(this.dailyIntervalTimeout);\n        await super.delete();\n        for (const a of this.panels) await a.delete();\n    }\n\n    async notificationToPanel(): Promise<void> {\n        if (!this.panels) return;\n        this.statesControler.setInternalState('///Notifications', true, true);\n    }\n\n    dailyInterval = (): void => {\n        this.getTasmotaVersion();\n    };\n\n    async getTasmotaVersion(): Promise<void> {\n        const urlString: string = 'https://api.github.com/repositories/80286288/releases/latest';\n        try {\n            const response = await axios(urlString, { headers: { 'User-Agent': 'ioBroker' } });\n\n            if (response && response.status === 200) {\n                const data = response.data as TasmotaOnlineResponse;\n\n                const TasmotaTagName = data.tag_name; // Filter JSON by \"tag_name\" and write to variable\n                const TasmotaVersionOnline = TasmotaTagName.replace(/v/i, ''); // Filter unnecessary \"v\" from variable and write to release variable\n                for (const p of this.panels) {\n                    if (p) {\n                        p.info.tasmota.onlineVersion = TasmotaVersionOnline;\n                    }\n                }\n            }\n        } catch (error) {}\n    }\n}\n"],
  "mappings": "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",
  "names": ["axios"]
}
