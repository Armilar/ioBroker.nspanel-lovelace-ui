{
  "version": 3,
  "sources": ["../../../src/lib/controller/panel-message.ts"],
  "sourcesContent": ["import { IClientPublishOptions } from 'mqtt';\nimport { SendTopicAppendix } from '../const/definition';\nimport { AdapterClassDefinition, BaseClass } from '../classes/library';\nimport { MQTTClientClass, callbackMessageType } from '../classes/mqtt';\nimport { Panel } from './panel';\n\n/**\n * \u00DCbernimmt das senden von Payloads an die mqtt Klasse - delay zwischen einzelnen Messages\n * 1 * pro Klasse Panel\n */\nexport class PanelSend extends BaseClass {\n    private messageDb: { payload: string; opt?: IClientPublishOptions }[] = [];\n    private messageDbTasmota: { topic: string; payload: string; opt?: IClientPublishOptions }[] = [];\n\n    private messageTimeout: ioBroker.Timeout | undefined;\n    private messageTimeoutTasmota: ioBroker.Timeout | undefined;\n    private mqttClient: MQTTClientClass;\n    private topic: string = '';\n\n    _panel: Panel | undefined = undefined;\n\n    constructor(adapter: AdapterClassDefinition, config: { name: string; mqttClient: MQTTClientClass; topic: string }) {\n        super(adapter, config.name);\n        this.mqttClient = config.mqttClient;\n        this.mqttClient.subscript(config.topic + '/stat/RESULT', this.onMessage);\n        this.topic = config.topic + SendTopicAppendix;\n    }\n    public set panel(panel: Panel) {\n        this._panel = panel;\n    }\n\n    onMessage: callbackMessageType = async (topic: string, message: string) => {\n        if (!topic.endsWith('/stat/RESULT')) {\n            //this.log.debug(`Receive command ${topic} with ${message}`);\n            return;\n        }\n        const msg = JSON.parse(message);\n        if (msg) {\n            if (msg.CustomSend === 'Done') {\n                if (this.messageTimeout) this.adapter.clearTimeout(this.messageTimeout);\n                this.log.debug(`Receive ack for ${JSON.stringify(this.messageDb.shift())}`);\n                this.sendMessageLoop();\n            }\n        }\n    };\n    public get panel(): Panel {\n        if (!this._panel) throw new Error('Error P1: Panel undefinied!');\n        return this._panel;\n    }\n\n    readonly addMessage = (payload: string, opt?: IClientPublishOptions): void => {\n        this.messageDb.push({ payload: payload, opt: opt });\n        if (this.messageTimeout === undefined) {\n            this.sendMessageLoop();\n        }\n    };\n\n    private readonly sendMessageLoop = (): void => {\n        const msg = this.messageDb[0];\n        if (msg === undefined || this.unload) {\n            this.messageTimeout = undefined;\n            return;\n        }\n        this.addMessageTasmota(this.topic, msg.payload, msg.opt);\n        this.messageTimeout = this.adapter.setTimeout(this.sendMessageLoop, 5000);\n    };\n\n    readonly addMessageTasmota = (topic: string, payload: string, opt?: IClientPublishOptions): void => {\n        if (\n            this.messageDbTasmota.length > 0 &&\n            !this.messageDbTasmota.some((a) => a.topic === topic && a.payload === payload && a.opt === opt)\n        )\n            return;\n        this.messageDbTasmota.push({ topic: topic, payload: payload, opt: opt });\n\n        if (this.messageTimeoutTasmota === undefined) {\n            this.sendMessageLoopTasmota();\n        }\n    };\n    private readonly sendMessageLoopTasmota = (): void => {\n        const msg = this.messageDbTasmota.shift();\n        if (msg === undefined || this.unload) {\n            this.messageTimeoutTasmota = undefined;\n            return;\n        }\n        this.log.debug(`send payload: ${JSON.stringify(msg)} to panel.`);\n        this.mqttClient.publish(msg.topic, msg.payload, msg.opt);\n        this.messageTimeoutTasmota = this.adapter.setTimeout(this.sendMessageLoopTasmota, 20);\n    };\n\n    async delete(): Promise<void> {\n        await super.delete();\n        if (this.messageTimeout) this.adapter.clearTimeout(this.messageTimeout);\n        if (this.messageTimeoutTasmota) this.adapter.clearTimeout(this.messageTimeoutTasmota);\n    }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AACA,wBAAkC;AAClC,qBAAkD;AAQ3C,MAAM,kBAAkB,yBAAU;AAAA,EAC7B,YAAgE,CAAC;AAAA,EACjE,mBAAsF,CAAC;AAAA,EAEvF;AAAA,EACA;AAAA,EACA;AAAA,EACA,QAAgB;AAAA,EAExB,SAA4B;AAAA,EAE5B,YAAY,SAAiC,QAAsE;AAC/G,UAAM,SAAS,OAAO,IAAI;AAC1B,SAAK,aAAa,OAAO;AACzB,SAAK,WAAW,UAAU,OAAO,QAAQ,gBAAgB,KAAK,SAAS;AACvE,SAAK,QAAQ,OAAO,QAAQ;AAAA,EAChC;AAAA,EACA,IAAW,MAAM,OAAc;AAC3B,SAAK,SAAS;AAAA,EAClB;AAAA,EAEA,YAAiC,OAAO,OAAe,YAAoB;AACvE,QAAI,CAAC,MAAM,SAAS,cAAc,GAAG;AAEjC;AAAA,IACJ;AACA,UAAM,MAAM,KAAK,MAAM,OAAO;AAC9B,QAAI,KAAK;AACL,UAAI,IAAI,eAAe,QAAQ;AAC3B,YAAI,KAAK;AAAgB,eAAK,QAAQ,aAAa,KAAK,cAAc;AACtE,aAAK,IAAI,MAAM,mBAAmB,KAAK,UAAU,KAAK,UAAU,MAAM,CAAC,GAAG;AAC1E,aAAK,gBAAgB;AAAA,MACzB;AAAA,IACJ;AAAA,EACJ;AAAA,EACA,IAAW,QAAe;AACtB,QAAI,CAAC,KAAK;AAAQ,YAAM,IAAI,MAAM,6BAA6B;AAC/D,WAAO,KAAK;AAAA,EAChB;AAAA,EAES,aAAa,CAAC,SAAiB,QAAsC;AAC1E,SAAK,UAAU,KAAK,EAAE,SAAkB,IAAS,CAAC;AAClD,QAAI,KAAK,mBAAmB,QAAW;AACnC,WAAK,gBAAgB;AAAA,IACzB;AAAA,EACJ;AAAA,EAEiB,kBAAkB,MAAY;AAC3C,UAAM,MAAM,KAAK,UAAU;AAC3B,QAAI,QAAQ,UAAa,KAAK,QAAQ;AAClC,WAAK,iBAAiB;AACtB;AAAA,IACJ;AACA,SAAK,kBAAkB,KAAK,OAAO,IAAI,SAAS,IAAI,GAAG;AACvD,SAAK,iBAAiB,KAAK,QAAQ,WAAW,KAAK,iBAAiB,GAAI;AAAA,EAC5E;AAAA,EAES,oBAAoB,CAAC,OAAe,SAAiB,QAAsC;AAChG,QACI,KAAK,iBAAiB,SAAS,KAC/B,CAAC,KAAK,iBAAiB,KAAK,CAAC,MAAM,EAAE,UAAU,SAAS,EAAE,YAAY,WAAW,EAAE,QAAQ,GAAG;AAE9F;AACJ,SAAK,iBAAiB,KAAK,EAAE,OAAc,SAAkB,IAAS,CAAC;AAEvE,QAAI,KAAK,0BAA0B,QAAW;AAC1C,WAAK,uBAAuB;AAAA,IAChC;AAAA,EACJ;AAAA,EACiB,yBAAyB,MAAY;AAClD,UAAM,MAAM,KAAK,iBAAiB,MAAM;AACxC,QAAI,QAAQ,UAAa,KAAK,QAAQ;AAClC,WAAK,wBAAwB;AAC7B;AAAA,IACJ;AACA,SAAK,IAAI,MAAM,iBAAiB,KAAK,UAAU,GAAG,aAAa;AAC/D,SAAK,WAAW,QAAQ,IAAI,OAAO,IAAI,SAAS,IAAI,GAAG;AACvD,SAAK,wBAAwB,KAAK,QAAQ,WAAW,KAAK,wBAAwB,EAAE;AAAA,EACxF;AAAA,EAEA,MAAM,SAAwB;AAC1B,UAAM,MAAM,OAAO;AACnB,QAAI,KAAK;AAAgB,WAAK,QAAQ,aAAa,KAAK,cAAc;AACtE,QAAI,KAAK;AAAuB,WAAK,QAAQ,aAAa,KAAK,qBAAqB;AAAA,EACxF;AACJ;",
  "names": []
}
