{
  "version": 3,
  "sources": ["../../../src/lib/pages/screensaver.ts"],
  "sourcesContent": ["import * as Definition from '../const/definition';\nimport * as Types from '../types/types';\n\n//import dayjs from 'dayjs';\n//import moment from 'moment';\n//import parseFormat from 'moment-parseformat';\nimport { Page, PageInterface } from '../classes/Page';\nimport * as pages from '../types/pages';\nimport * as tools from '../const/tools';\nimport { PageItem } from './pageItem';\nimport { BaseClassTriggerd } from '../controller/states-controller';\n\nexport type ScreensaverConfigType = {\n    momentLocale: string;\n    locale: string; //Intl.DateTimeFormat;\n    iconBig1: boolean;\n    iconBig2: boolean;\n};\n\nexport class Screensaver extends Page {\n    items: undefined;\n    private step: number = 0;\n    private blockButtons: ioBroker.Timeout | undefined;\n    private headlinePos: number = 0;\n    private titelPos: number = 0;\n    private nextArrow: boolean = false;\n    private rotationTime: number = 300000;\n    private timoutRotation: ioBroker.Timeout | undefined = undefined;\n    constructor(config: PageInterface, options: pages.PageBaseConfig) {\n        if (!options.config || (options.config.card !== 'screensaver' && options.config.card !== 'screensaver2'))\n            return;\n        switch (options.config.mode) {\n            case 'standard':\n            case 'alternate': {\n                config.card = 'screensaver';\n                break;\n            }\n            case 'advanced': {\n                config.card = 'screensaver2';\n                break;\n            }\n        }\n        config.alwaysOn = 'none';\n        super(config, options);\n        //moment.locale(this.conddffig2.momentLocale);\n        this.rotationTime =\n            options.config.rotationTime !== 0 && options.config.rotationTime < 3\n                ? 3000\n                : options.config.rotationTime * 1000;\n    }\n\n    async init(): Promise<void> {\n        await super.init();\n        await this.createPageItems();\n    }\n\n    async getData(places: Types.ScreenSaverPlaces[]): Promise<pages.screensaverMessage | null> {\n        const config = this.config;\n        if (!config || (config.card !== 'screensaver' && config.card !== 'screensaver2')) return null;\n        const message: pages.screensaverMessage = {\n            options: {\n                indicator: [],\n                left: [],\n                time: [],\n                date: [],\n                bottom: [],\n                mricon: [],\n                favorit: [],\n                alternate: [],\n            },\n        };\n\n        if (this.pageItems) {\n            const model = config.model;\n            const layout = config.mode;\n            for (let a = 0; a < this.pageItems.length; a++) {\n                const pageItems: PageItem | undefined = this.pageItems[a];\n                const options = message.options;\n                if (pageItems && pageItems.config && pageItems.config.modeScr) {\n                    const place = pageItems.config.modeScr;\n                    const max = Definition.ScreenSaverConst[layout][place].maxEntries[model];\n                    if (max === 0) continue;\n                    if (places.indexOf(place) === -1) continue;\n\n                    const arr = options[place] || [];\n                    arr.push(await pageItems.getPageItemPayload());\n                    options[place] = arr;\n                }\n            }\n            for (const x in message.options) {\n                const place = x as Types.ScreenSaverPlaces;\n                if (places.indexOf(place) === -1) continue;\n                let items = message.options[place];\n                if (items) {\n                    const max = Definition.ScreenSaverConst[layout][place].maxEntries[model];\n                    if (items.length > Definition.ScreenSaverConst[layout][place].maxEntries[model]) {\n                        let f = items.length / Definition.ScreenSaverConst[layout][place].maxEntries[model];\n                        f = this.step % Math.ceil(f);\n                        message.options[place] = items.slice(max * f, max * (f + 1));\n                    }\n                    items = message.options[place];\n                    for (let i = 0; i < max; i++) {\n                        const msg = items[i];\n                        if (!msg) {\n                            items[i] = tools.getPayload('', '', '', '', '', '');\n                        } else {\n                            const arr = items[i].split('~');\n                            arr[0] = '';\n                            if (place !== 'indicator') arr[1] = '';\n                            items[i] = tools.getPayloadArray(arr);\n                        }\n                    }\n                }\n            }\n        }\n        return message;\n    }\n    async update(): Promise<void> {\n        if (!this.visibility) {\n            this.log.error('get update command but not visible!');\n            return;\n        }\n\n        const message = await this.getData(['left', 'bottom', 'indicator', 'alternate', 'favorit']);\n        if (message === null) return;\n        if (message.options.alternate.length > 0)\n            message.options.alternate.unshift(tools.getPayload('', '', '', '', '', ''));\n        const arr: string[] = message.options.favorit.concat(\n            message.options.left,\n            message.options.bottom,\n            message.options.alternate,\n            message.options.indicator,\n        );\n        const msg = tools.getPayload('weatherUpdate', tools.getPayloadArray(arr));\n\n        this.sendToPanel(msg);\n        this.HandleScreensaverStatusIcons();\n    }\n\n    async onVisibilityChange(v: boolean): Promise<void> {\n        //await super.onVisibilityChange(v);\n        this.step = -1;\n        if (v) {\n            await this.sendType();\n            await this.update();\n            this.rotationLoop();\n        } else {\n            if (this.timoutRotation) this.adapter.clearTimeout(this.timoutRotation);\n        }\n    }\n    rotationLoop = async (): Promise<void> => {\n        if (this.unload) return;\n        // only use this if screensaver is activated\n        if (!this.visibility) return;\n        this.step++ > 100;\n\n        await this.update();\n\n        if (this.rotationTime === 0) return;\n        this.timoutRotation = this.adapter.setTimeout(\n            this.rotationLoop,\n            this.rotationTime < 3000 ? 3000 : this.rotationTime,\n        );\n    };\n\n    onStateTrigger = async (_dp: string, from: BaseClassTriggerd): Promise<void> => {\n        const config = this.config;\n        if (!config || (config.card !== 'screensaver' && config.card !== 'screensaver2')) return;\n        if (from instanceof PageItem && this.pageItems) {\n            const index = parseInt(from.id.split('?')[1]);\n            const item = this.pageItems[index];\n            if (item && item.config) {\n                const place = item.config.modeScr;\n                if (place !== undefined) {\n                    switch (place) {\n                        case 'left':\n                        case 'bottom':\n                        case 'indicator':\n                        case 'alternate':\n                        case 'favorit': {\n                            await this.update();\n                            break;\n                        }\n                        case 'mricon': {\n                            await this.HandleScreensaverStatusIcons();\n                            break;\n                        }\n                        case 'time': {\n                            this.HandleTime();\n                            break;\n                        }\n                        case 'date': {\n                            this.HandleDate();\n                            break;\n                        }\n                    }\n                }\n            }\n        }\n    };\n    async HandleTime(): Promise<void> {\n        const message = await this.getData(['time']);\n        if (message === null || !message.options.time[0]) return;\n        this.sendToPanel(`time~${message.options.time[0].split('~')[5]}`);\n    }\n    async HandleDate(): Promise<void> {\n        const message = await this.getData(['date']);\n        if (message === null || !message.options.date[0]) return;\n        this.sendToPanel(`date~${message.options.date[0].split('~')[5]}`);\n    }\n\n    async HandleScreensaverStatusIcons(): Promise<void> {\n        if (!this.visibility) {\n            this.log.error('get update command but not visible!');\n            return;\n        }\n\n        const message = await this.getData(['mricon']);\n        if (message === null) return;\n        const mrIcon1 = message.options.mricon[0].split('~');\n        const mrIcon2 = message.options.mricon[1].split('~');\n        const msgArray: string[] = [\n            'statusUpdate',\n            mrIcon1[2] ?? '',\n            mrIcon1[3] ?? '',\n            mrIcon2[2] ?? '',\n            mrIcon2[3] ?? '',\n            this.panel.info.nspanel.bigIconLeft ? '1' : '',\n            this.panel.info.nspanel.bigIconRight ? '1' : '',\n        ];\n        const msg = tools.getPayloadArray(msgArray);\n        this.sendToPanel(msg);\n    }\n\n    async onButtonEvent(event: Types.IncomingEvent): Promise<void> {\n        if (event.page && event.id && this.pageItems && this.pageItems[event.id as any]) {\n            if (this.blockButtons) return;\n            this.pageItems[event.id as any]!.onCommand(event.action, event.opt);\n            this.blockButtons = this.adapter.setTimeout(() => {\n                this.blockButtons = undefined;\n            }, 500);\n        }\n    }\n\n    async delete(): Promise<void> {\n        await super.delete();\n        if (this.timoutRotation) this.adapter.clearTimeout(this.timoutRotation);\n        if (this.blockButtons) this.adapter.clearTimeout(this.blockButtons);\n    }\n}\n"],
  "mappings": "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",
  "names": []
}
